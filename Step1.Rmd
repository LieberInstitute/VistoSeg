# Step 1: Split Visium histology whole slide image into individual capture area images

The visium histology whole slide image from the imaging system (slide scanner) is a multiplane tif image (~20GB). The sample image [Liebert_Institute_OTS-20-7690_rush_anterior.tif](link to AWS) from the DLPFC dataset is used here to run through the pipeline. 

The inputs to the function [splitSlide.m](https://github.com/LieberInstitute/VisiumLIBD/blob/main/code/splitSlide.m) are 
1. the full path with file name of the raw multiplane tif image

The function imports the raw multiplane tif image and saves each plane/image as matlab structure and all structures are saved into a single cell array (I) in a '.mat file'. The 1st image of the raw multiplane tif is the raw visium histology slide image, the remaining planes/images consists of the metadata. 

The function then splits the 1st image of the multiplane tif into individual capture areas (A1,B1,C1,D1) and saves them as both `tif images` and `mat files`. The capture areas are resized to 70% of the original size (eg 100 X 100 Pixel region is resized to 70 X 70 pixel region) when saving to tif images as matlab cannot store images that occupies more than 2^32 - 1 bytes of data.

```matlab
fname = '/path_to_multiplane_tif/Liebert_Institute_OTS-20-7748_rush_posterior.tif';

splitSlide(fname)



```

The sample multiplane tif file has 7 images shown below.

<img src="images/img1.png" title="Image 1" /> <img src="images/img2.png" title="Image 2" /> <img src="images/img3.png" title="Image 3" /> <img src="images/img4.png" title="Image 4" /> <img src="images/img5.png" title="Image 5" /> <img src="images/img6.png" title="Image 6" /> <img src="images/img7.png" title="Image 7" /><br/>

Though most of the images look same, the first image in the multiplane tif is the high resolution image of the slide based on the image size (y,x,z) in pixels shown below in matlab. 

```matlab
load('/path_to_multiplane_tif/Liebert_Institute_OTS-20-7748_rush_posterior.mat')
size(I,2) %number of images in the multiplane tif

size(I{1}.image)

ans =

       53384      160858           3

size(I{2}.image)

ans =

         339        1024           3

size(I{3}.image)

ans =

       13346       40214           3
       
size(I{4}.image)

ans =

        3336       10053           3

size(I{5}.image)  

ans =

         834        2513           3

size(I{6}.image)

ans =

         777         765           3

size(I{7}.image)  

ans =

         612        1600           3

```

The image I{1}.image is split into 4 sub images or capture areas by dividing the x(160858) dimesion into 4 equal parts. Sometimes the center of the image is not the center of the slide, in such case the offset is adjusted manually. 

